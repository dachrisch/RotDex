name: PR and Branch Check

on:
  pull_request:
    branches: [ main, master ]
  push:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  pre_job:
    name: Check Duplicate
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: 'same_content_newer'
          skip_after_successful_duplicate: 'true'
          paths_ignore: '["**/README.md", "**/docs/**", "**/*.md", ".gitignore", "LICENSE"]'
          do_not_skip: '["workflow_dispatch"]'

  compile:
    name: Compilation Check
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Compile Kotlin sources
      run: ./gradlew compileDebugKotlin compileDebugAndroidTestKotlin --no-daemon
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [pre_job, compile]
    if: needs.pre_job.outputs.should_skip != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run Lint
        id: lint
        continue-on-error: true
        run: ./gradlew lintDebug

      - name: Upload Lint Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: lint-results
          path: app/build/reports/lint-results-debug.html

      - name: Fail if Lint Failed
        if: steps.lint.outcome == 'failure'
        run: exit 1

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [pre_job, compile]
    if: needs.pre_job.outputs.should_skip != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run Unit Tests
        id: tests
        continue-on-error: true
        run: ./gradlew testDebugUnitTest

      - name: Upload Test Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/testDebugUnitTest/

      - name: Fail if Tests Failed
        if: steps.tests.outcome == 'failure'
        run: exit 1

  build-apks:
    name: Build APK (${{ matrix.variant }})
    runs-on: ubuntu-latest
    needs: [pre_job, lint, test, code-quality, build-check]
    if: needs.pre_job.outputs.should_skip != 'true'
    strategy:
      matrix:
        variant: [debug, release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Setup Debug Keystore
      if: matrix.variant == 'debug'
      run: |
        mkdir -p ~/.android
        echo "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" | base64 -d > ~/.android/debug.keystore

    - name: Build ${{ matrix.variant }} APK
      run: ./gradlew assemble${{ matrix.variant == 'debug' && 'Debug' || 'Release' }}

    - name: Upload ${{ matrix.variant }} APK
      uses: actions/upload-artifact@v5
      with:
        name: ${{ matrix.variant }}-apk
        path: app/build/outputs/apk/${{ matrix.variant }}/*.apk
        retention-days: 7

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [pre_job, compile]
    if: needs.pre_job.outputs.should_skip != 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Check build configuration
      run: ./gradlew assembleDebug --dry-run

    - name: Validate Gradle Wrapper
      uses: gradle/actions/wrapper-validation@v5

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: [pre_job, compile]
    if: needs.pre_job.outputs.should_skip != 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Run detekt
      id: detekt
      run: ./gradlew detekt
      continue-on-error: true

    - name: Upload detekt report
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: detekt-report
        path: build/reports/problems/

    - name: Fail if Detekt  Failed
      if: steps.detekt.outcome == 'failure'
      run: exit 1
